{% extends "layout.html" %}
{% block title %}Editor | Room {{ room_id }}{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<style>
  .editor-wrapper {
    display: flex;
    gap: 20px;
    height: calc(100vh - 120px);
  }
  
  .code-container {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .left-panel, .right-panel {
    flex: 1;
    display: flex; /* Make them flex containers */
    flex-direction: column; /* Stack content vertically */
    min-width: 280px;
    max-width: 350px;
    background: var(--dark-card);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid var(--border-color);
  }
  
  .editor-container {
    flex-grow: 1;
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  #monaco-editor {
    width: 100%;
    height: 100%;
  }

  .output-section {
    flex-basis: 30%;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 150px;
  }
  
  #output {
    flex-grow: 1;
    background: #0f172a;
    color: var(--text-light);
    border-radius: 8px;
    padding: 15px;
    border: 1px solid var(--border-color);
    overflow-y: auto;
    font-family: 'Fira Code', monospace;
    font-size: 13px;
    white-space: pre-wrap;
  }
  
  .participant-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    margin-bottom: 8px;
    background: rgba(144, 211, 224, 0.1);
    border-radius: 8px;
  }
  
  .participant-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    margin-right: 10px;
  }
  
  .owner-badge {
    background: var(--primary);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
  }
  
  .room-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .room-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-light);
  }
  
  .room-actions {
    display: flex;
    gap: 10px;
  }
  
  .run-section {
    display: flex;
    gap: 10px;
  }
  
  .status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--secondary);
    margin-right: 8px;
  }
  
  .output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chatbot-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1; /* Allow it to grow vertically within left-panel */
    min-height: 200px;
    background: var(--dark-card);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 15px;
    margin-top: 0px;
  }

  .chatbot-messages {
    flex-grow: 1; /* Allow messages area to grow */
    overflow-y: auto;
    margin-bottom: 10px;
    padding: 5px;
  }
  
  .user-message, .ai-message {
    padding: 10px 15px; /* Increased padding */
    margin-bottom: 8px;
    border-radius: 12px;
    font-size: 15px; /* Increased font size */
    line-height: 1.6; /* Improved line height for readability */
    word-wrap: break-word; /* Ensure long words break */
    white-space: pre-wrap; /* Preserve whitespace and allow wrapping */
  }

  .user-message {
    text-align: right;
    color: var(--text-light);
    background: rgba(82, 121, 179, 0.3); /* Slightly darker transparent blue */
  }
  .ai-message {
    text-align: left;
    color: var(--text-light);
    background: rgba(144, 211, 224, 0.3); /* Slightly darker transparent light blue */
  }
  
  .chatbot-input {
    display: flex;
    gap: 10px;
    width: 100%; /* Ensure it takes full width */
  }
  
  .chatbot-input .form-control {
    flex-grow: 1; /* Make input field take available space */
  }

  /* General Chat Styling */
  .general-chat-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1; /* Allow it to grow vertically within right-panel */
    background: var(--dark-card);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 15px;
    margin-top: 15px; /* Space from participants list */
  }

  .general-chat-messages {
    flex-grow: 1;
    overflow-y: auto; /* Enable scrolling */
    margin-bottom: 10px;
    padding: 5px;
    font-size: 14px;
  }

  .general-chat-message-item {
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 10px;
    background: rgba(179, 168, 212, 0.2); /* Soft purple transparent */
    color: var(--text-light);
    word-wrap: break-word;
  }

  .general-chat-sender {
    font-weight: bold;
    color: var(--secondary); /* Highlight sender name */
    margin-right: 5px;
  }

  .general-chat-input {
    display: flex;
    gap: 10px;
    width: 100%;
    margin-top: auto; /* Pushes the input to the bottom */
  }

  .general-chat-input .form-control {
    flex-grow: 1;
  }

</style>
{% endblock %}

{% block body %}
<div class="py-3 px-5 animate__animated animate__fadeIn">
  <div class="room-header">
    <div>
      <span class="room-title">
        <i class="fas fa-code me-2"></i>Room: <span id="room-id-display">{{ room_id }}</span>
        <span class="status-indicator" id="connection-status"></span>
      </span>
    </div>
    <div class="room-actions">
      <button class="btn btn-sm btn-outline-light btn-3d" onclick="downloadCode()">
        <i class="fas fa-download me-1"></i> Download
      </button>
      <button class="btn btn-sm btn-danger btn-3d" onclick="leaveRoom()">
        <i class="fas fa-sign-out-alt me-1"></i> Leave
      </button>
    </div>
  </div>

  <div class="editor-wrapper">
    <!-- Left Panel for AI Chatbot -->
    <div class="left-panel animate__animated animate__fadeInLeft glass-effect">
      <div class="chatbot-container">
        <h6 class="text-light mb-3">
          <i class="fas fa-robot me-2"></i>AI Chatbot
        </h6>
        <div id="chatbot-messages" class="chatbot-messages">
          <!-- Chat messages will be appended here -->
        </div>
        <div class="chatbot-input">
          <input type="text" id="chatbot-input" class="form-control" placeholder="Ask about the code...">
          <button id="chatbot-send-btn" class="btn btn-sm btn-primary">Send</button>
        </div>
      </div>
    </div>

    <!-- Center Section for Code Editor and Output -->
    <div class="code-container">
      <div class="editor-container glass-effect">
        <div id="monaco-editor"></div>
      </div>
      
      <div class="output-section">
        <div class="output-header">
          <h6 class="text-light mb-0">
            <i class="fas fa-terminal me-2"></i>Console Output
          </h6>
          <button id="clearBtn" class="btn btn-sm btn-outline-light">
            <i class="fas fa-trash-alt me-1"></i> Clear
          </button>
        </div>
        <pre id="output"></pre>
        <div class="run-section">
          <input id="input" class="form-control" placeholder="Input (for stdin)">
          <button id="runBtn" class="btn btn-success btn-3d">
            <i class="fas fa-play me-1"></i> Run
          </button>
        </div>
      </div>
    </div>
    
    <!-- Right Panel for Participants List and General Chat -->
    <div class="right-panel animate__animated animate__fadeInRight glass-effect">
      <h6 class="text-light mb-3">
        <i class="fas fa-users me-2"></i>Participants (<span id="participant-count">1</span>)
      </h6>
      <div id="participants-list">
        <div class="participant-item">
          <img src="{{ user.avatar }}" class="participant-avatar">
          <span>{{ user.name }}</span>
          <span class="owner-badge">Owner</span>
        </div>
      </div>

      <!-- General Chat Section -->
      <div class="general-chat-container">
        <h6 class="text-light mb-3">
          <i class="fas fa-comments me-2"></i>Room Chat
        </h6>
        <div id="general-chat-messages" class="general-chat-messages">
          <!-- General chat messages will be appended here -->
        </div>
        <div class="general-chat-input">
          <input type="text" id="general-chat-input" class="form-control" placeholder="Type a message...">
          <button id="general-chat-send-btn" class="btn btn-sm btn-primary">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.26.1/min/vs/loader.js"></script>
<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.26.1/min/vs' }});
require(['vs/editor/editor.main'], function() {
    const editor = monaco.editor.create(document.getElementById('monaco-editor'), {
        value: '# Start coding collaboratively...\n# Python code will be synced in real-time',
        language: 'python',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 16,
        wordWrap: 'on',
        minimap: { enabled: false }
    });

    const room_id = "{{ room_id }}";
    const socket = io();
    let isOwner = true;
    let isLocalChange = false;

    const runBtn = document.getElementById('runBtn');
    const output = document.getElementById('output');
    const input = document.getElementById('input');
    const clearBtn = document.getElementById('clearBtn');
    const participantsList = document.getElementById('participants-list');
    const participantCount = document.getElementById('participant-count');
    const connectionStatus = document.getElementById('connection-status');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSendBtn = document.getElementById('chatbot-send-btn');
    const generalChatMessages = document.getElementById('general-chat-messages');
    const generalChatInput = document.getElementById('general-chat-input');
    const generalChatSendBtn = document.getElementById('general-chat-send-btn');
    
    // Remote change handler
    socket.on('remote_change', function(data) {
        if (data.sender !== '{{ user.id }}') {
            isLocalChange = true;
            editor.setValue(data.content);
            isLocalChange = false;
        }
    });

    // Local change handler
    editor.onDidChangeModelContent((event) => {
        if (!isLocalChange) {
            socket.emit('text_change', { room_id, content: editor.getValue() });
        }
    });
    
    function leaveRoom() {
        if (confirm("Are you sure you want to leave this room?")) {
            socket.emit('leave_room_event', {room_id});
            window.location.href = `{{ url_for('home') }}`;
        }
    }

    function downloadCode() {
        const codeContent = editor.getValue();
        const filename = 'my_code.py'; // Default filename

        const blob = new Blob([codeContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href); // Clean up the URL object
    }

    window.downloadCode = downloadCode; // Expose to global scope
    window.leaveRoom = leaveRoom;
    
    // Socket.IO events
    socket.on('connect', function() {
        connectionStatus.style.backgroundColor = '#90d3e0';
        socket.emit('join', {room_id});
    });

    socket.on('disconnect', function() {
        connectionStatus.style.backgroundColor = '#ff4d4d';
    });

    socket.on('connect_error', function() {
        connectionStatus.style.backgroundColor = '#ff4d4d';
    });
    
    socket.on('code_output', function(data) {
        let outputText = data.output;
        
        if (outputText.includes('Error:')) {
            output.innerHTML = `<span class="error">${outputText}</span>`;
        } else {
            output.innerHTML = outputText;
        }
        
        output.scrollTop = output.scrollHeight;
    });
    
    socket.on('participants_update', function(data) {
        participantsList.innerHTML = '';
        let count = 0;
        
        data.participants.forEach(participant => {
            const participantElement = document.createElement('div');
            participantElement.className = 'participant-item';
            participantElement.innerHTML = `
                <img src="${participant.avatar}" class="participant-avatar">
                <span>${participant.name}</span>
                ${participant.is_owner ? '<span class="owner-badge">Owner</span>' : ''}
            `;
            participantsList.appendChild(participantElement);
            count++;
        });
        
        participantCount.textContent = count;
    });
    
    socket.on('unauthorized', function(data) {
        alert("Session expired, please login again.");
        window.location.href = "{{ url_for('login') }}";
    });
    
    runBtn.addEventListener('click', function() {
        const code = editor.getValue();
        if (!code.trim()) return;
        runBtn.disabled = true;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Running';
        socket.emit('run_code', {room_id, code: code, input: input.value});
        
        socket.once('code_output', function() {
            runBtn.disabled = false;
            runBtn.innerHTML = '<i class="fas fa-play me-1"></i> Run';
        });
    });
    
    clearBtn.addEventListener('click', function() {
        output.innerHTML = '';
    });
    
    // AI Chatbot logic
    function addChatbotMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.className = sender === 'user' ? 'user-message' : 'ai-message';
        messageElement.textContent = message; 
        chatbotMessages.appendChild(messageElement);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    chatbotSendBtn.addEventListener('click', function() {
      const query = chatbotInput.value;
      if (query.trim() === '') return;
      const currentCode = editor.getValue();
      addChatbotMessage('user', 'You: ' + query);
      socket.emit('chatbot_request', { room_id, query, code: currentCode });
      chatbotInput.value = '';
    });

    chatbotInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        chatbotSendBtn.click();
      }
    });

    socket.on('chatbot_response', function(data) {
      addChatbotMessage('ai', 'AI: ' + data.ai_response);
    });

    // General Chat logic
    function addGeneralChatMessage(senderName, message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'general-chat-message-item';
        messageElement.innerHTML = `<span class="general-chat-sender">${senderName}:</span> ${message}`;
        generalChatMessages.appendChild(messageElement);
        generalChatMessages.scrollTop = generalChatMessages.scrollHeight;
    }

    generalChatSendBtn.addEventListener('click', function() {
        const message = generalChatInput.value;
        if (message.trim() === '') return;
        socket.emit('general_chat_message', { room_id, message: message });
        generalChatInput.value = '';
    });

    generalChatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        generalChatSendBtn.click();
      }
    });

    socket.on('new_general_chat_message', function(data) {
        addGeneralChatMessage(data.sender_name, data.message);
    });

    // Set initial connection status
    connectionStatus.style.backgroundColor = '#90d3e0';
});
</script>
{% endblock %}